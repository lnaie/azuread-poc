using System;using System.IO;using System.Linq;using System.Net.Http;using System.Security.Authentication;using System.Threading.Tasks;using IdentityServer;using IdentityModel.Client;using Microsoft.Extensions.Configuration;using Newtonsoft.Json.Linq;namespace IdentityClient{    class Program    {        static async Task Main(string[] args)        {            Console.WriteLine();            Console.WriteLine("IdentityClient");            var configurationBuilder = new ConfigurationBuilder()                .SetBasePath(Directory.GetCurrentDirectory())                .AddJsonFile("appsettings.json", optional: false, reloadOnChange: false)                .AddJsonFile("appsettings.Development.json", optional: true, reloadOnChange: false);            var configuration = configurationBuilder.Build();            // Discover endpoints from metadata            var discoClient = new HttpClient();            var discoResponse = await discoClient.GetDiscoveryDocumentAsync(new DiscoveryDocumentRequest            {                Address = configuration["IdentityServer:Authority"],                Policy = new DiscoveryPolicy                {                    ValidateIssuerName = false,                }            });            if (discoResponse.IsError)            {                Console.WriteLine();                Console.WriteLine($"IDS discovery error: " + discoResponse.Error);                Console.WriteLine();                return;            }            var handler = new HttpClientHandler()            {                SslProtocols = SslProtocols.Tls12 | SslProtocols.Tls11 | SslProtocols.Tls            };            var apiBaseUrl = configuration["IdentityApi:BaseUrl"];            var apiClient = new HttpClient(handler, true);            await ProbeM2MClient(discoClient, discoResponse, apiClient, apiBaseUrl);            await ProbeUserPasswdClient("alice", discoClient, discoResponse, apiClient, apiBaseUrl);        }        private static async Task ProbeUserPasswdClient(            string username,            HttpClient discoClient, DiscoveryDocumentResponse discoResponse,            HttpClient apiClient, string apiBaseUrl)        {            // Request User & Passwd token            var user = TestUsers.GetUsers().First(x => x.Username == username);            var tokenResponse2 = await discoClient.RequestPasswordTokenAsync(new PasswordTokenRequest            {                Address = discoResponse.TokenEndpoint,                UserName = user.Username,                Password = user.Password,                ClientId = "ids-ownerpasswd",                ClientSecret = "op-secret-01",                Scope = "openid profile api.management api.public",            });            if (tokenResponse2.IsError)            {                Console.WriteLine();                Console.WriteLine("IDS User & Passwd token request error: " + tokenResponse2.Error);                Console.WriteLine();                return;            }            Console.WriteLine();            Console.WriteLine("IDS User & Passwd token response:");            Console.WriteLine(tokenResponse2.AccessToken);            Console.WriteLine();            apiClient.SetBearerToken(tokenResponse2.AccessToken);            // Call identity api            var apiResponse3 = await apiClient.GetAsync($"{apiBaseUrl}/users/identity");            if (!apiResponse3.IsSuccessStatusCode)            {                Console.WriteLine("Identity API response status code error: " + apiResponse3.StatusCode);                Console.WriteLine();            }            else            {                var content3 = await apiResponse3.Content.ReadAsStringAsync();                Console.WriteLine("Identity API response:");                Console.WriteLine(JArray.Parse(content3));                Console.WriteLine();            }            // Call public api            var apiResponse4 = await apiClient.GetAsync($"{apiBaseUrl}/users/public");            if (!apiResponse4.IsSuccessStatusCode)            {                Console.WriteLine("Public API response status code error: " + apiResponse4.StatusCode);                Console.WriteLine();            }            else            {                var content4 = await apiResponse4.Content.ReadAsStringAsync();                Console.WriteLine("Public API response:");                Console.WriteLine(content4);                Console.WriteLine();            }            // Call manage api            var apiResponse5 = await apiClient.GetAsync($"{apiBaseUrl}/users/manage");            if (!apiResponse5.IsSuccessStatusCode)            {                Console.WriteLine("Manage API response status code error: " + apiResponse5.StatusCode);                Console.WriteLine();            }            else            {                var content5 = await apiResponse5.Content.ReadAsStringAsync();                Console.WriteLine("Manage API response:");                Console.WriteLine(content5);                Console.WriteLine();            }        }        private static async Task ProbeM2MClient(            HttpClient discClient, DiscoveryDocumentResponse discoResponse,            HttpClient apiClient, string apiBaseUrl)        {            // Request M2M token            var tokenResponse1 = await discClient.RequestClientCredentialsTokenAsync(new ClientCredentialsTokenRequest            {                Address = discoResponse.TokenEndpoint,                ClientId = "ids-m2m",                ClientSecret = "m2m-secret-01",                Scope = "api.management api.public",            });            if (tokenResponse1.IsError)            {                Console.WriteLine();                Console.WriteLine("IDS M2M token request error: " + tokenResponse1.Error);                Console.WriteLine();                return;            }            Console.WriteLine();            Console.WriteLine("IDS M2M token response:");            Console.WriteLine(tokenResponse1.AccessToken);            Console.WriteLine();            apiClient.SetBearerToken(tokenResponse1.AccessToken);            // Call identity api            var apiResponse1 = await apiClient.GetAsync($"{apiBaseUrl}/users/identity");            if (!apiResponse1.IsSuccessStatusCode)            {                Console.WriteLine("Identity API response status code error: " + apiResponse1.StatusCode);                Console.WriteLine();            }            else            {                var content1 = await apiResponse1.Content.ReadAsStringAsync();                Console.WriteLine("Identity API response:");                Console.WriteLine(JArray.Parse(content1));                Console.WriteLine();            }            // Call manage api            var apiResponse2 = await apiClient.GetAsync($"{apiBaseUrl}/users/manage");            if (!apiResponse2.IsSuccessStatusCode)            {                Console.WriteLine("Manage API response status code error: " + apiResponse2.StatusCode);                Console.WriteLine();            }            else            {                var content2 = await apiResponse2.Content.ReadAsStringAsync();                Console.WriteLine("Manage API response:");                Console.WriteLine(content2);                Console.WriteLine();            }        }    }}